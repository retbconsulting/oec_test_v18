<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="my_profil">
        <t t-call="portal.portal_layout">
            <t t-set="additional_title">Mon profil</t>
            <form action="/cotisation/new" method="post" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                <div class="row" style="background-color: #fff; margin-bottom:20px; margin-top:20px">
                    <div class="form-group col-xl-12">
                        <label class="col-form-label" for="name">
                            <t t-if="partner.mode_registration != 'pm'">Nom</t>
                            <t t-else="">Nom et prénom</t>
                        </label>
                        <input type="text" name="name" t-att-value="partner.name or ''" class="form-control"
                               readonly="1"
                               style="box-shadow: 0 1px 1px #16181b;"/>
                    </div>
                </div>
            </form>
        </t>
    </template>

    <template id="oec_portal_new_cotisation" name="OEC New Cotisation">
        <style>
            h2 {
            width: 420px;
            }
            .o_website_calendar ul.wizard li {
            font-size : medium;
            }
            .table-responsive{
            margin-top: 1rem !important;
            }
            .avatar-text {
            padding: 12px 40px;
            position: relative;
            left: -20px;
            /*z-index: 1;*/
            border-top-right-radius: 30px;
            border-bottom-right-radius: 30px;
            background: linear-gradient(
            90deg, rgb(205 166 163) 0%, rgb(255 255 255 / 93%) 100%);
            color: #9f2a2e;
            }

            .avatar-container {
            display: flex;
            align-items: center;
            left: 60px;
            top: -10px;
            padding-top: 100px
            }

            .avatar img {
            z-index: 100;
            border-radius: 50px;
            width: 80px;
            box-shadow: 0px 0px 6px 3px rgb(0 0 0 / 35%);
            }

            .avatar {
            z-index: 100;
            }

            input[type=number] {
            text-align: right;
            }

            #ca_amount {
            text-align: right;
            }

            #discount {
            text-align: right;
            }

            #top {
            display:none;
            }

            #wrapwrap.o_portal {
            background-color: #80808000 !important;
            background-size: 100vw 100vh;
            background-image: url('/mandat_cotisation_management/static/src/img/background-3.png');
            }


            .o_portal_wrap .o_portal_navbar {
            background-color: white !important;
            display: none;
            }

            .o_portal_wrap{
            margin-top: 49px;
            }

            table {
            background-color: #ffffff00 !important;
            }
            .i-header {
            background-image: url('/mandat_cotisation_management/static/src/img/top-layer.png');
            width: 100vw;
            height: 190px;
            background-repeat: no-repeat;
            background-size: 100vw 153px;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1000;
            display:flex;
            }
            .i-header ul {
            display: flex;
            list-style: none;
            color: white;
            }

            .i-header li {
            margin: 25px 20px;
            }

            .i-header .buttons button {
            background: #9a3131;
            padding: 4px 30px;
            border: none;
            border-radius: 40px;
            color: white;
            backdrop-filter: blur(0px);
            margin-top: 7px;
            display: flex;
            justify-content: center;
            }
            .i-header .buttons .button{
            background: #b6a9a8ad;
            padding: 4px 30px;
            border: none;
            border-radius: 40px;
            color: white;
            backdrop-filter: blur(0px);
            margin-top: 7px;
            }

            .i-header .buttons {
            display: flex;
            flex-direction: column;
            position: absolute;
            right: 33px;
            top: 33px;
            }

            .h-divider {
            width: 2px;
            height: 28px;
            background: white;
            margin: 22px -3px;
            }

            main {
            margin-left: 0px;
            }

            .table-responsive {
            margin-top: 9rem;
            }

            ul li a {
            color: white;
            }

            ul li a:hover {
            color: white;
            text-decoration: underline;
            }

            .button a:hover {
            color: white;
            text-decoration: none;
            }


            .i-header .buttons .button {
            background: #9a3131;
            padding: 4px 30px;
            border: none;
            border-radius: 40px;
            color: white;
            backdrop-filter: blur(0px);
            margin-top: 7px;
            display: flex;
            justify-content: center;
            }

            #bottom {
            display: none;
            }
            .i-header .buttons {
            display: flex;
            flex-direction: column;
            position: absolute;
            right: 33px;
            top: 14px;
            }

            .i-header {
            background-image: url('/mandat_cotisation_management/static/src/img/top-layer.png');
            width: 100vw;
            height: 190px;
            background-repeat: no-repeat;
            background-position-x: center;
            background-size: 120vw 153px;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1000;
            display: flex;
            }
            @media only screen and (max-width: 900px){
            .i-header {
            background-size: 100vw 80px;
            }
            .i-header ul {
            display: none;
            }
            .i-header .buttons {
            display: flex;
            flex-direction: row;
            align-items: center;
            margin-top: -25px;
            }

            main {
            margin-left:0px !important;

            }

            #wrapwrap.o_portal {
            background-color: #80808000 !important;
            background-size: auto !important;
            background-image: url('/mandat_cotisation_management/static/src/img/background-3.png');
            }

            .i-header .buttons {
            gap: 17px;
            top: 29px;
            }

            }

            /* Red-themed progress bar container */
            .progress-tracker {
            display: flex;
            width: 100%;
            margin: 2rem 0;
            padding: 0;
            list-style: none;
            position: relative;
            }

            /* Background track - replaced with individual segments */
            .progress-tracker:before {
            display: none; /* Remove the continuous background track */
            }

            /* Step styling */
            .progress-tracker li {
            flex: 1;
            position: relative;
            padding: 0 10px;
            text-align: center;
            z-index: 2;
            font-size: 0.85rem;
            font-weight: 500;
            color: #AAAAAA;
            transition: all 0.3s ease;
            }

            /* Add segmented background lines */
            .progress-tracker li:not(:last-child):after {
            content: '';
            position: absolute;
            top: 20px;
            left: calc(50% + 25px); /* Start after the circle */
            width: calc(100% - 50px); /* Width between circles */
            height: 2px;
            background-color: transparent;
            z-index: 0;
            }

            /* Step indicator circles - now separate from the line */
            .progress-tracker li:before {
            content: '';
            display: block;
            width: 36px;
            height: 36px;
            background-color: #BBBBBB;
            border: 2px solid #ddd;
            border-radius: 50%;
            margin: 0 auto 10px;
            transition: all 0.3s ease;
            position: relative;
            z-index: 2;
            }

            /* Active step */
            .progress-tracker li.text-primary {
            color: #9C343C;
            font-weight: 1000;
            }

            .progress-tracker li.text-primary:before {
            background-color: #9C343C;
            border-color: #BB8080;
            box-shadow: 0 0 0 4px rgba(230, 57, 70, 0.2);
            }

            /* Completed steps */
            .progress-tracker li.completed {
            color: #6a6a6a;
            }

            .progress-tracker li.completed:before {
            background-color: #e63946;
            border-color: #e63946;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='15'
            viewBox='0 0 12 10'%3E%3Cpath fill='%23FFFFFF' d='M4.5 8.5L1.5 5.5 0 7 4.5 11.5 14.5 1.5 13
            0z'/%3E%3C/svg%3E");
            background-position: center;
            background-repeat: no-repeat;
            }

            /* Completed steps line segments */
            .progress-tracker li.completed:not(:last-child):after {
            background-color: #e63946;
            }

            /* Hover effect */
            .progress-tracker li:hover {
            color: #e63946;
            }

            /* Responsive design */
            @media (max-width: 768px) {
            .progress-tracker {
            flex-direction: column;
            margin-left: 30px;
            }

            /* Vertical line segments for mobile */
            .progress-tracker li:not(:last-child):after {
            top: 50px;
            left: 18px;
            width: 2px;
            height: calc(100% - 20px);
            }

            .progress-tracker li {
            text-align: left;
            padding: 0 0 30px 60px;
            margin-bottom: 10px;
            }

            .progress-tracker li:before {
            position: absolute;
            left: 0;
            top: 0;
            margin: 0;
            }
            }
        </style>
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True"/>
            <!-- Header (TO IMPROVE!) -->
            <div class="i-header">
                <ul>
                    <li>
                        <a href="/cotisations">
                            Mes cotisations
                        </a>
                    </li>
                    <div class="h-divider"/>
                    <li>
                        <a href="/declarations">
                            Mes déclarations de mandats
                        </a>
                    </li>
                    <div class="h-divider"/>
                    <li>
                        <a href="/">
                            Mes stagiaires encadrés
                        </a>
                    </li>
                    <div class="h-divider"/>
                    <li>
                        <a href="/">
                            Mes stagiaires contrôlés
                        </a>
                    </li>
                    <div class="h-divider"/>
                    <li>
                        <a href="/">
                            Mes contrôles qualité
                        </a>
                    </li>
                    <div class="h-divider"/>
                    <li>
                        <a href="/rendez-vous">
                            Rendez-vous
                        </a>
                    </li>
                    <div class="h-divider"/>
                    <li>
                        <a href="event">
                            Événements
                        </a>
                    </li>
                    <div class="h-divider"/>
                    <li>
                        <a href="/my">
                            Retour à la page d'acceuil
                        </a>
                    </li>
                </ul>
            </div>

            <!-- Avatar (Small bug to solve: Default placeholder) -->
            <div class="avatar-container">
                <div class="avatar">
                    <t t-if="user_id.image_256" t-set="avatar_source" t-value="image_data_uri(user_id.image_256)"/>
                    <t t-else="" t-set="avatar_source" t-value="'/web/static/src/img/placeholder.png'"/>
                    <img t-att-src="avatar_source" t-attf-class="rounded-circle #{_avatar_class}" alt="" loading="eager"/>
                </div>
                <div class="avatar-text">
                    <span t-esc="user_id.name"/>
                </div>
            </div>

            <t t-set="additional_title">Nouvelle cotisation</t>

            <!-- Main Form (Almost good)-->
            <form action="/cotisation/new" method="post" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>

                <!-- Progress Bar (Good) -->
                <div class="row">
                    <div class="form-group col-xl-12">
                        <div class="row">
                            <ul class="progress-tracker mt32 w-100">
                                <li t-attf-class="#{state=='draft' and 'text-primary' or 'text-muted'} #{state!='draft' and state!='none' and 'completed' or ''}">
                                    <span>Brouillon</span>
                                </li>
                                <li t-attf-class="#{state=='waiting_validation' and 'text-primary' or 'text-muted'} #{state!='draft' and state!='waiting_validation' and state!='none' and 'completed' or ''}">
                                    <span>En attente de validation</span>
                                </li>
                                <li t-attf-class="#{state=='validated' and 'text-primary' or 'text-muted'} #{state!='draft' and state!='waiting_validation' and state!='validated' and state!='none' and 'completed' or ''}">
                                    <span>Validée en attente de paiement</span>
                                </li>
                                <li t-attf-class="#{state=='payment_submitted' and 'text-primary' or 'text-muted'} #{(state=='payment_validated' or state=='comptabilise') and 'completed' or ''}">
                                    <span>Paiement soumis</span>
                                </li>
                                <li t-attf-class="#{(state=='payment_validated' or state=='comptabilise') and 'text-primary' or 'text-muted'}">
                                    <span>Paiement validé</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Variables -->
                <t t-set="cotisation_instance" t-value="request.env['oec.cotisation'].sudo().browse(cotisation)"/>
                <t t-set="partner" t-value="cotisation_instance.partner_id"/>
                <!-- It would be better to move this to the controller -->
                <t t-set="discount_comments" t-value="[f'Inscrit avant le 30 novembre {int(cotisation_instance.year) - 2}', f'Inscrit entre le 30 novembre {int(cotisation_instance.year) - 2} et le 1er decembre {int(cotisation_instance.year) - 1}', f'Inscrit a partir du 1er decembre {int(cotisation_instance.year) - 1}']"/>

                <!-- Section: IDENTIFICATION DU CABINET (little remarks) -->
                <div class="row" style="background-color: #fff;margin-bottom:20px;margin-top:20px">
                    <!-- Section Title -->
                    <h2 style="display: inline-block;border-top-left-radius: 6px;border-top-right-radius: 6px;margin: 0;padding: 0 20px;color: #fff;font-size: 14px;line-height: 40px;background:linear-gradient(150deg, #814747 20%, #630000 80%) !important">
                        IDENTIFICATION DU CABINET
                    </h2>

                    <!-- Year Field -->
                    <div class="form-group col-xl-12">
                        <label class="col-form-label" for="year">Année</label>
                        <input type="text" name="year" t-att-value="cotisation_instance.year or ''" class="form-control" readonly="1" style="box-shadow: 0 1px 1px #16181b;"/>
                    </div>

                    <!-- Registration Date Field -->
                    <div class="form-group col-xl-12">
                        <label class="col-form-label" for="creation_date">Date d'inscription</label>
                        <input type="text" name="creation_date" t-att-value="partner.date_inscription or ''" class="form-control" readonly="1" style="box-shadow: 0 1px 1px #16181b;"/>
                    </div>

                    <!-- Name Field -->
                    <div class="form-group col-xl-12">
                        <label class="col-form-label" for="name">
                            <!--<t t-if="partner.mode_registration != 'pm'">Nom</t>-->
                            <t t-if="not partner.parent_id">Nom</t>
                            <t t-else="">Nom et prénom</t>
                        </label>
                        <input type="text" name="name" t-att-value="partner.parent_id.name or ''" class="form-control" readonly="1" style="box-shadow: 0 1px 1px #16181b;"/>
                    </div>

                    <!-- Second Name Field -->
                    <!--<div class="form-group col-xl-12" t-if="partner.mode_registration != 'pm'">-->
                    <div class="form-group col-xl-12" t-if="not partner.parent_id">
                        <label class="col-form-label" for="prenom">Prénom</label>
                        <input type="text" name="prenom" t-att-value="prenom or ''" class="form-control" readonly="1" style="box-shadow: 0 1px 1px #16181b;"/>
                    </div>

                    <!-- Address Field -->
                    <div class="form-group col-xl-12">
                        <label class="col-form-label" for="adresse">
                            <!--<t t-if="partner.mode_registration != 'pm'">Adresse</t>-->
                            <t t-if="not partner.parent_id">Adresse</t>
                            <t t-else="">Siège sociale</t>
                        </label>
                        <!--<input type="text" name="adresse" class="form-control" readonly="1" style="box-shadow: 0 1px 1px #16181b;" t-att-value="partner.street if partner.mode_registration != 'pm' else partner.parent_id.street"/>-->
                        <input type="text" name="adresse" class="form-control" readonly="1" style="box-shadow: 0 1px 1px #16181b;" t-att-value="partner.street if not partner.parent_id else partner.parent_id.street"/>
                    </div>

                    <!-- Cotisation reference (if required, hidden input wouldn't be better?) -->
                    <div class="form-group col-xl-6" style="display:none;">
                        <label class="col-form-label" for="cotisation">Cotisation</label>
                        <input type="text" name="cotisation" t-att-value="cotisation or ''" class="form-control"/>
                    </div>

                    <!-- Diff reference (if required, hidden input wouldn't be better?) -->
                    <div class="form-group col-xl-6" style="display:none;">
                        <label class="col-form-label" for="diff">Cotisation</label>
                        <input type="number" name="diff" t-att-value="diff or ''" class="form-control diff" id="diff"/>
                    </div>
                </div>

                <!-- Section: COTISATION FIXE (Fine for now)-->
                <div class="row" style="background-color: #fff;margin-bottom:20px;margin-top:20px">
                    <!-- Section Title -->
                    <h2 style="display: inline-block;border-top-left-radius: 6px;border-top-right-radius: 6px;margin: 0;padding: 0 20px;color: #fff;font-size: 14px;line-height: 40px;background:linear-gradient(150deg, #814747 20%, #630000 80%) !important">
                        COTISATION FIXE
                    </h2>

                    <t t-if="partner.mode_registration != 'pm'">
                        <!-- Subsection Title -->
                        <div class="col-xl-12">
                            <label class="col-form-label" style="font-size: 20px;margin-top: 20px;font-weight: 600;" for="title_aa">
                                Personne physique:
                            </label>
                        </div>
                        <div class="form-group col-xl-6">
                            <label class="col-form-label" for="number_members">Nombre de membres de
                                l'ordre exerçant dans la structure (A)
                            </label>
                        </div> <!-- Just a label -->
                        <div class="form-group col-xl-6">
                            <input type="number" name="number_members" oninput="formatNumber(this); updateTotals()" t-att-value="number_members or 0" class="form-control" id="member_number" t-att-readonly="None if (state=='draft') else '1'"/>
                        </div> <!-- get id = member_number -->
                        <div class="form-group col-xl-6">
                            <label class="col-form-label" for="amount_member">Montant par membre de
                                l'ordre (B)
                            </label>
                        </div> <!-- Just a label -->
                        <div class="form-group col-xl-6">
                            <input style="box-shadow: 0 1px 1px #16181b;" step="0.01" type="number" oninput="(function(el){el.value=parseFloat(el.value).toFixed(2);})(this); updateTotals()" name="amount_member" value="4000" class="form-control" id="member_amount" t-att-readonly="None if (state=='draft') else '1'"/>
                        </div> <!-- get id = member_amount -->
                        <div class="form-group col-xl-6">
                            <label class="col-form-label" style="color:blue" for="amount_member">Total (A*B) = (G)
                            </label>
                            <input type="hidden" name="amount_member" class="form-control" id="hidden_total_g"/>
                        </div> <!-- Just a label -->
                        <div class="form-group col-xl-6" style="text-align: right;">
                            <b>
                                <span id="label_total_g" style="font-size:16px"/>
                            </b>
                        </div>
                    </t> <!-- (DONE) -->

                    <t t-if="partner.mode_registration == 'pm'">
                        <!-- Subsection Title -->
                        <div class="col-xl-12">
                            <label class="col-form-label" style="font-size: 20px;margin-top: 20px; font-weight: 600;" for="title_aa">
                                Personne Morale:
                            </label>
                        </div>

                        <br/>
                        <br/>

                        <!-- Montant cotisation hors remise -->
                        <div class="form-group col-xl-6">
                            Montant cotisation hors remise
                            <input style="box-shadow: 0 1px 1px #16181b;display: none;" oninput="updateTotals()" disabled="disabled" type="number" name="amount_member_c" t-att-value="amount_member_c or 0" class="form-control" id="amount_member_c" t-att-readonly="None if (state=='draft' and mode_registration != 'pm') else '1'"/>
                        </div> <!-- get id = amount_member_c -->
                        <div style="text-align:right" class="form-group col-xl-6">
                            <strong>
                                <span name="label_amount_member_c" t-att-value="label_amount_member_c or 0" id="label_amount_member_c" style="font-size:16px">2 000 DH
                                </span>
                            </strong>
                        </div>
                        <!-- Taux de remise -->
                        <div class="form-group col-xl-6">
                            Taux de remise
                        </div>
                        <div class="form-group col-xl-6">
                            <select class="form-control" name="discount" onchange="updateTotals()" t-att-readonly="None if state=='draft' else '1'" readonly="0" id="discount">
                                <t t-foreach="enumerate(suggested_discount or [])" t-as="suggested_discount">
                                    <t t-set="discount_" t-value="discount_comments[suggested_discount[0]] + ' (' + suggested_discount[1][0] + ')'"/>
                                    <option t-att-selected="suggested_discount[1][1] == discount" t-att-value="suggested_discount[1][0]">
                                        <t t-esc="discount_"/>
                                    </option>
                                </t>
                            </select>
                        </div> <!-- get id = discount -->

                        <br/>

                        <!-- Subsection Title -->
                        <div class="col-xl-12">
                            <label class="col-form-label" style="font-size: 20px;margin-top: 20px; font-weight: 600;" for="title_aa">
                                Personnes Physiques:
                            </label>
                        </div>
                        <!-- Nombre de membres de l'ordre exerçant dans la structure -->
                        <div class="form-group col-xl-12">
                            <label class="col-form-label" for="number_members_2">Nombre de membres de l'ordre exerçant
                                dans la structure
                            </label>
                        </div> <!-- Title -->
                        <div class="form-group col-xl-6">
                            Non exonéré (<b>D1</b>)
                            <span class="col-form-label comment_noexo" for="comment_noexo" id="comment_noexo" style="color:red"/>
                        </div> <!-- Non Exonérés -->
                        <div class="form-group col-xl-6">
                            <input style="box-shadow: 0 1px 1px #16181b;" type="number" oninput="updateTotals()" name="number_members_2" t-att-value="number_members_2 or 0" class="form-control" id="number_member_d" t-att-readonly="None if (state=='draft') else '1'"/>
                        </div> <!-- Non Exonérés -->
                        <div class="form-group col-xl-6">
                            Bénéficiares de 50% de remise (<b>D2</b>)
                            <span class="col-form-label" for="comment_50" id="comment_50" style="color:red"/>
                        </div> <!-- 50% remise -->
                        <div class="form-group col-xl-6">
                            <input style="box-shadow: 0 1px 1px #16181b;" type="number" oninput="updateTotals()" name="number_members_50" t-att-value="number_members_50 or 0" class="form-control" id="number_members_50" t-att-readonly="None if (state=='draft') else '1'"/>
                        </div> <!-- 50% remise -->
                        <div class="form-group col-xl-6">
                            Exonérés (<b>D3</b>)
                            <span class="col-form-label comment_exo" for="comment_exo" id="comment_exo" style="color:red"/>
                        </div> <!-- Exonérés -->
                        <div class="form-group col-xl-6">
                            <input style="box-shadow: 0 1px 1px #16181b;" type="number" oninput="updateTotals()" name="number_members_exo" t-att-value="number_members_exo or 0" class="form-control" id="number_members_exo" t-att-readonly="None if (state=='draft') else '1'"/>
                        </div> <!-- Exonérés -->

                        <div class="form-group col-xl-6">
                            <label class="col-form-label" for="amount_member_2">Montant par membre de l'ordre (E)
                            </label>
                            <input style="box-shadow: 0 1px 1px #16181b;display: none;" type="number" oninput="updateTotals()" name="amount_member_2" disabled="disabled" t-att-value="amount_member_2 or 0" class="form-control" id="amount_member_e" t-att-readonly="None if (state=='draft') else '1'"/>
                        </div> <!-- Montant par membre de l'ordre (E) -->
                        <div style="text-align:right" class="form-group col-xl-6">
                            <b>
                                <span name="label_amount_member_2" t-att-value="label_amount_member_2 or 0" id="label_amount_member_2" style="font-size:16px">4 000 DH
                                </span>
                            </b>
                        </div> <!-- Montant par membre de l'ordre (E) -->
                    </t>

                    <div class="form-group col-xl-6">
                        <label class="col-form-label" for="amount_member_2">Sous total (D1 * E * 100% + D2 * E * 50% +
                            D3 * E * 0%) = (F)
                        </label>
                        <!--                        <span t-esc="total_f"/>-->
                        <input type="hidden" name="total_f" class="form-control" id="hidden_total_f"/>
                    </div> <!-- Subtotal (F) -->
                    <div style="text-align:right" class="form-group col-xl-6">
                        <b>
                            <span id="label_total_f" style="font-size:16px"/>
                        </b>
                    </div> <!-- Subtotal (F) -->

                    <div class="form-group col-xl-6">
                        <label class="col-form-label" style="color:blue" for="total_g">Total (C+F) = (G)
                        </label>
                        <!--                        <span t-esc="total_g_2"/>-->
                        <input type="hidden" name="total_g_2" class="form-control" id="hidden_total_g_2"/>
                    </div> <!-- Total (G) -->
                    <div style="text-align:right" class="form-group col-xl-6">
                        <b>
                            <span id="label_total_g_2" style="font-size:16px"/>
                        </b>
                    </div> <!-- Total (G) -->
                </div>

                <!-- Section: COTISATION FIXE DE 1000 DH PAR BUREAU SECONDAIRE (DONE) -->
                <div t-if="partner.mode_registration == 'pm'" class="row" style="background-color: #fff;margin-bottom:20px;margin-top:20px">
                    <h2 style="display: inline-block;border-top-left-radius: 6px;border-top-right-radius: 6px;margin: 0;padding: 0 20px;color: #fff;font-size: 14px;line-height: 40px;background:linear-gradient(150deg, #814747 20%, #630000 80%) !important">
                        COTISATION FIXE DE 1000 DH PAR BUREAU SECONDAIRE
                    </h2>
                    <br/>
                    <div class="form-group col-xl-6">
                        <label class="col-form-label" for="s_office_number">Nombre de bureaux secondaires
                        </label>
                    </div> <!-- Nombre de bureaux secondaires -->
                    <div class="form-group col-xl-6">
                        <input style="box-shadow: 0 1px 1px #16181b;" type="number" oninput="updateTotals()" name="s_office_number" t-att-value="s_office_number or 0" class="form-control" id="number_s_office" t-att-readonly="None if state=='draft' else '1'"/>
                    </div> <!-- Nombre de bureaux secondaires -->
                    <br/>
                    <div class="form-group col-xl-6">
                        <label class="col-form-label" for="label_s_office">Cotisation fixe par bureau secondaire
                        </label>
                    </div> <!-- Cotisation fixe par bureau secondaire -->
                    <div style="text-align:right" class="form-group col-xl-6">
                        <b>
                            <span name="label_amount_s_office" id="label_amount_s_office" style="font-size:16px">1 000
                                DH
                            </span>
                        </b>
                    </div> <!-- Cotisation fixe par bureau secondaire -->

                    <div class="form-group col-xl-6">
                        <label class="col-form-label" style="color:blue" for="total_i2">Total (I2)
                        </label>
                        <input type="hidden" name="total_i2" class="form-control" id="hidden_total_i2"/>
                    </div> <!-- Total (I2) -->
                    <div style="text-align: right" class="form-group col-xl-6">
                        <b>
                            <span id="label_total_i2" style="font-size:16px"/>
                        </b>
                    </div> <!-- Total (I2) -->
                </div>

                <!-- Section: COTISATION VARIABLE (DONE) -->
                <div class="row" style="background-color: #fff;margin-bottom:20px;margin-top:20px">
                    <!-- Section Title -->
                    <h2 style="display: inline-block;border-top-left-radius: 6px;border-top-right-radius: 6px;margin: 0;padding: 0 20px;color: #fff;font-size: 14px;line-height: 40px;background:linear-gradient(150deg, #814747 20%, #630000 80%) !important">
                        COTISATION VARIABLE
                    </h2>
                    <br/>
                    <div class="form-group col-xl-6">
                        <label class="col-form-label" for="ca">Chiffre d'affaires
                        </label>
                    </div> <!-- CA -->
                    <div class="form-group col-xl-6">
                        <input style="box-shadow: 0 1px 1px #16181b;" type="text" oninput="formatNumber(this); updateTotals();" name="ca" t-att-value="ca or 0" class="form-control" id="ca_amount" t-att-readonly="None if state=='draft' else '1'"/>
                    </div> <!-- CA -->

                    <div class="form-group col-xl-6">
                        <label style="font-size:12px" class="col-form-label" for="l_ca_1">De 0 à
                            <label id="ca_plafond_1"/>
                            dirhams à 0,25 %
                        </label>
                    </div> <!-- CA Tranche 1 -->
                    <div class="form-group col-xl-6" style="text-align:right">
                        <input type="hidden" name="ca_tranche_1" class="form-control" id="hidden_ca_tranche_1"/>
                        <b>
                            <span id="label_ca_tranche_1" style="font-size:16px"/>
                        </b>
                    </div> <!-- CA Tranche 1 -->

                    <div class="form-group col-xl-6" id="l_ca_section_2">
                        <label style="font-size:12px" class="col-form-label" for="l_ca_2">De 50 000 000 à
                            <label id="ca_plafond_2"/>
                            dirhams à 0,15 %
                        </label>
                    </div> <!-- CA Tranche 2 -->
                    <div class="form-group col-xl-6" id="ca_section_2" style="text-align:right">
                        <input type="hidden" name="ca_tranche_2" class="form-control" id="hidden_ca_tranche_2"/>
                        <b>
                            <span id="label_ca_tranche_2" style="font-size:16px"/>
                        </b>
                    </div> <!-- CA Tranche 2 -->

                    <div class="form-group col-xl-6">
                        <label class="col-form-label" style="color:blue" for="total_h">Total (H)
                        </label>
                        <input type="hidden" name="total_h" class="form-control" id="hidden_total_h"/>
                    </div> <!-- Total (H) -->
                    <div style="text-align:right" class="form-group col-xl-6">
                        <b>
                            <span id="label_total_h" style="font-size:16px"/>
                        </b>
                    </div> <!-- Total (H) -->

                    <t t-if="state == 'draft'">
                        <div class="col-xl-12">
                            <label class="col-form-label" style="margin-top: 20px;" for="justif_ca">
                                Joindre l'attestation de CA
                                <input type="hidden" id="justif_ca_loaded" t-att-value="justif_ca"/>
                            </label>
                        </div>
                        <!-- File Loaded Indicator -->
                        <div class="mt-2 file-exists-indicator" id="file_indicator">
                            <div class="d-flex align-items-center">
                                <i class="fa fa-check-circle text-success mr-2"/>
                                <span style="margin-left: 20px; margin-right: 50px;">
                                    Fichier chargé:
                                    <span style="color:green;" id="attached_justif_ca">Document</span>
                                </span>
                                <button type="button" class="btn btn-sm btn-outline-secondary ml-2" style="border-width: 3px; font-weight: 700; border-color: #954040; color: #954040;" id="change_justif_ca" onclick="changeJustifFile()" onmouseover="highlightButton(this)" onmouseout="resetButtonStyle(this)">
                                    Changer le fichier
                                </button>
                            </div>
                        </div>

                        <!-- File Input Field -->
                        <div class="form-group col-xl-6" data-type="binary">
                            <input type="file" class="file" name="justif_ca" id="justif_ca" t-att-value="justif_ca" t-att-data-saved="justif_ca or ''" style="box-shadow: 0 1px 1px #16181b;" onchange="handleFileChange(this)" data-show-upload="true" data-show-caption="true" data-show-preview="true"/>
                        </div>
                    </t> <!-- Justif CA -->
                </div>

                <!-- Section: COTISATION FIXE DE 200 DH PAR MANDAT DE CAC ET/OU D'AUDIT  (DONE) -->
                <div class="row" style="background-color: #fff;margin-bottom:20px;margin-top:20px">
                    <!-- Section Title -->
                    <h2 style="display: inline-block;border-top-left-radius: 6px;border-top-right-radius: 6px;margin: 0;padding: 0 20px;color: #fff;font-size: 14px;line-height: 40px;background:linear-gradient(150deg, #814747 20%, #630000 80%) !important">
                        COTISATION FIXE DE 200 DH PAR MANDAT DE CAC ET/OU D'AUDIT
                    </h2>
                    <br/>
                    <div class="form-group col-xl-6">
                        <label class="col-form-label" for="mandat_number">Nombre de mandats
                        </label>
                    </div> <!-- Nombre de mandat -->
                    <div class="form-group col-xl-6">
                        <input style="box-shadow: 0 1px 1px #16181b;" type="number" oninput="updateTotals()" name="mandat_number" t-att-value="mandat_number or 0" class="form-control" id="number_mandat" t-att-readonly="None if state=='draft' else '1'"/>
                    </div> <!-- Nombre de mandat -->
                    <br/>
                    <div class="form-group col-xl-6">
                        <label class="col-form-label" for="label_mandat">Cotisation fixe par mandat
                        </label>
                    </div> <!-- Cotisation fixe par mandat -->
                    <div style="text-align:right" class="form-group col-xl-6">
                        <b>
                            <span name="label_amount_mandat" id="label_amount_mandat" style="font-size:16px">200 DH
                            </span>
                        </b>
                    </div> <!-- Cotisation fixe par mandat -->

                    <div class="form-group col-xl-6">
                        <label class="col-form-label" style="color:blue" for="total_i">Total (I1)
                        </label>
                        <!--                        <span t-esc="total_i"/>-->
                        <input type="hidden" name="total_i" class="form-control" id="hidden_total_i"/>
                    </div> <!-- Total (I1) -->
                    <div style="text-align:right" class="form-group col-xl-6">
                        <b>
                            <span id="label_total_i" style="font-size:16px"/>
                        </b>
                    </div> <!-- Total (I1) -->
                </div>

                <!-- Section: COTISATION IFOEC (DONE)-->
                <div class="row" style="background-color: #fff;margin-bottom:20px;margin-top:20px">
                    <h2 style="display: inline-block;border-top-left-radius: 6px;border-top-right-radius: 6px;margin: 0;padding: 0 20px;color: #fff;font-size: 14px;line-height: 40px;background:linear-gradient(150deg, #814747 20%, #630000 80%) !important">
                        COTISATION IFOEC
                    </h2>
                    <br/>
                    <div class="form-group col-xl-6">
                        Membres non exonérés
                        <span class="col-form-label comment_noexo" for="comment_noexo" id="comment_noexo" style="color:red"/>
                    </div> <!-- Membres non exonérés -->
                    <div style="text-align:right" class="form-group col-xl-6">
                        <b>
                            <span id="label_members_2" style="font-size:16px">0</span>
                        </b>
                    </div> <!-- Membres non exonérés -->

                    <div class="form-group col-xl-6">
                        Membres exonérés
                        <span class="col-form-label comment_exo" for="comment_noexo" id="comment_exo" style="color:red"/>
                    </div> <!-- Membres exonérés -->
                    <div style="text-align:right" class="form-group col-xl-6">
                        <b>
                            <span id="label_members_exo" style="font-size:16px">0</span>
                        </b>
                    </div> <!-- Membres exonérés -->

                    <div class="form-group col-xl-6">
                        <label class="col-form-label" for="label_amount_member_ifoec">Montant par membre
                        </label>
                    </div> <!-- Montant par membre -->
                    <div style="text-align:right" class="form-group col-xl-6">
                        <b>
                            <span name="label_amount_member_ifoec" id="label_amount_member_ifoec" style="font-size:16px">1 500 DH
                            </span>
                        </b>
                    </div> <!-- Montant par membre -->

                    <div class="form-group col-xl-6">
                        <label class="col-form-label" style="color:blue" for="total_j">Total (J)
                        </label>
                        <input type="hidden" name="total_j" class="form-control" id="hidden_total_j"/>
                    </div> <!-- Total (J) -->
                    <div style="text-align:right" class="form-group col-xl-6">
                        <b>
                            <span id="label_total_j" style="font-size:16px"/>
                        </b>
                    </div> <!-- Total (J) -->
                </div>

                <!-- Section: Payment -->
                <div class="row" style="background-color: #fff;margin-bottom:20px;margin-top:20px">
                    <!-- Section Title -->
                    <h2 style="display: inline-block;border-top-left-radius: 6px;border-top-right-radius: 6px;margin: 0;padding: 0 20px;color: #fff;font-size: 14px;line-height: 40px;background:linear-gradient(150deg, #814747 20%, #630000 80%) !important">
                        TOTAL A PAYER
                    </h2>
                    <br/>
                    <div class="form-group col-xl-6">
                        <t t-if="partner.mode_registration == 'pm'">
                            <label class="col-form-label" style="color:red" for="total">Total à payer (G) + (H) + (I1) + (I2) + (J)
                            </label>
                            <input type="hidden" name="total" class="form-control" id="hidden_pm_total"/>
                        </t> <!-- Total Label -->
                        <t t-else="">
                            <label class="col-form-label" style="color:red" for="total">Total à payer (G) + (H) + (I1) + (J)</label>
                            <input type="hidden" name="total" class="form-control" id="hidden_no_pm_total"/>
                        </t> <!-- Total Label -->
                    </div> <!-- Total -->

                    <div style="text-align:right" class="form-group col-xl-6">
                        <b>
                            <span id="label_pm_total" style="font-size:16px" t-if="partner.mode_registration == 'pm'"/>
                            <span id="label_no_pm_total" style="font-size:16px" t-if="partner.mode_registration != 'pm'"/>
                        </b>
                    </div> <!-- Total -->

                    <t t-if="state == 'validated'">
                        <div class="form-group col-xl-6">
                            <label class="col-form-label" for="modalite_payment">Modalité de paiement</label>
                        </div> <!-- Modalité de paiement -->
                        <div class="form-group col-xl-6">
                            <select class="form-control" name="modalite_payment" onchange="handlePaymentSection()" id="modalite_payment" t-att-readonly="'1' if state=='payment_validated' else None">
                                <option value="cheque">Chèque</option>
                                <option value="virement">Virement</option>
                                <!--<option value="en_ligne">En ligne</option>-->
                            </select>
                        </div> <!-- Modalité de paiement -->

                        <div class="form-group col-xl-6" id="cheque1">
                            <label class="col-form-label" for="numero_cheque">Numéro de chèque</label>
                        </div> <!-- Num Chèque -->
                        <div class="form-group col-xl-6" id="cheque2">
                            <input style="box-shadow: 0 1px 1px #16181b;" type="text" name="numero_cheque" t-att-value="numero_cheque or 0" class="form-control" id="numero_cheque" t-att-readonly="'1' if state=='payment_validated' else None"/>
                        </div> <!-- Num Chèque -->
                        <div class="form-group col-xl-6" id="cheque3">
                            <label class="col-form-label" for="amount_cheque">Montant du chèque</label>
                        </div> <!-- Montant Chèque -->
                        <div class="form-group col-xl-6" id="cheque4">
                            <input style="box-shadow: 0 1px 1px #16181b;" type="text" oninput="formatNumber(this)" name="amount_cheque" t-att-value="amount_cheque or 0" class="form-control" id="amount_cheque" t-att-readonly="'1' if state=='payment_validated' else None"/>
                        </div> <!-- Montant Chèque -->

                        <div class="col-xl-12">
                            <label class="col-form-label" style="margin-top: 20px;" for="join_report_2">Joindre le
                                justificatif du
                                paiement
                            </label>
                        </div> <!-- Justif Paiement -->
                        <div class="form-group col-xl-6" data-type="binary">
                            <input style="box-shadow: 0 1px 1px #16181b;" type="file" name="justificatif" class="file" data-show-upload="true" data-show-caption="true" data-show-preview="true" id="justificatif"/>
                        </div> <!-- Justif Paiement -->
                        <div class="form-group col-xl-12">
                            <input type="checkbox" class="payment_condition" id="payment_condition" name="payment_condition" value="payment_condition" onclick="acceptPaymentCondition()">
                                <b>Le moyen/justificatif de paiement sera transmis dans les meilleurs délais au Conseil
                                    Régional de l'OEC
                                </b>
                            </input>
                        </div> <!-- Payment terms -->
                    </t> <!-- Payment -->
                </div>

                <!-- A hidden section to track the value of total before submission -->
                <div class="form-group col-xl-6" style="display: 'none';">
                    <input type="hidden" t-att-value="total or 0" class="form-control" id="exact_total"/>
                </div>

                <!-- Submit Buttons -->
                <div class="row" id="report_submit">
                    <div class="col-lg-12 d-flex justify-content-between">
                        <t t-if="state == 'draft'">
                            <button type="submit" class="btn btn-outline-danger" onclick="return checkJustifCA();">
                                Enregistrer
                            </button>
                        </t>
                        <t t-if="state == 'draft' and total_h != 0.0">
                            <a t-attf-href="/cotisation/#{id}/submit" class="btn btn-outline-danger" onclick="return checkJustifCA();">
                                Soumettre
                            </a>
                        </t>
                        <t t-if="state == 'validated'">
                            <button style="display : none" type="submit" class="btn btn-outline-danger" id="soumettre" onclick="return checkAmount();">Soumettre
                            </button>
                        </t>
                    </div>
                </div>
            </form>
        </t>
        <script>
            /* Utils */
            function formatNumber(input) {
                let value = input.value.replace(/\s+/g, ''); // Remove existing spaces
                let formattedValue = value.replace(/\B(?=(\d{3})+(?!\d))/g, " "); // Add spaces

                input.value = formattedValue;
            };

            function getFormattedNumberValue(input) {
                return parseFloat(input.value.replace(/\s+/g, '')).toFixed(2);
            };

            function normalize(percentageString) {
                const num = parseFloat(percentageString.replace('%', '').trim());
                return isNaN(num) ? 0 : num / 100;
            };

            /* Validity Checks */
            function checkJustifCA() {
                let loaded_file = document.getElementById('justif_ca_loaded').value;
                let uploaded_file = document.getElementById('justif_ca').value;
                if (!loaded_file &amp;&amp; !uploaded_file) {
                    alert('Veuillez fournir un justificatif du CA');
                    return false;
                };
                return true;
            };

            function checkAmount() {
                let paymentSelectEl = document.getElementById('modalite_payment');
                let total_value = getFormattedNumberValue(document.getElementById('exact_total'));
                if (paymentSelectEl) {
                    if (paymentSelectEl.value === 'cheque') {
                        let amount_cheque = document.getElementById('amount_cheque');
                        amount_cheque.value = getFormattedNumberValue(amount_cheque);
                        if (amount_cheque.value !== total_value) {
                            alert('Le montant du chèque est différent du total de cotisation');
                            return false;
                        };
                    };
                };
            };

            /* DOM Handlers */
            function handleFileChange(input) {
                const fileIndicator = document.getElementById('file_indicator');
                const fileInput = document.getElementById('justif_ca');
                const fileNameSpan = document.getElementById('attached_justif_ca');

                if (input.files &amp;&amp; input.files.length &gt; 0) {
                    fileInput.style.display = 'none';
                    fileIndicator.style.display = 'block';
                    fileNameSpan.textContent = input.files[0].name;
                }
            };

            function loadJustifFile() {
                let loaded_file = document.getElementById('justif_ca_loaded').value;
                if (loaded_file || loaded_file.trim() !== '') {
                    document.getElementById('file_indicator').style.display = 'block';
                    document.getElementById('justif_ca').style.display = 'none';
                    document.getElementById('attached_justif_ca').textContent = loaded_file;
                } else {
                    document.getElementById('file_indicator').style.display = 'none';
                }
            };

            function changeJustifFile() {
                document.getElementById('file_indicator').style.display = 'none';
                document.getElementById('justif_ca').style.display = 'block';
            };

            function highlightButton(btn) {
                btn.style.backgroundColor = '#954040';
                btn.style.color = '#ffffff';
            };

            function resetButtonStyle(btn) {
                btn.style.backgroundColor = '';
                btn.style.color = '#954040';
            };

            function handlePaymentSection() {
                let paymentSelectEl = document.getElementById('modalite_payment');
                if (paymentSelectEl) {
                    if (paymentSelectEl.value === 'cheque') {
                        document.getElementById('cheque1').style.display = 'block';
                        document.getElementById('cheque2').style.display = 'block';
                        document.getElementById('cheque3').style.display = 'block';
                        document.getElementById('cheque4').style.display = 'block';
                    } else {
                        document.getElementById('cheque1').style.display = 'none';
                        document.getElementById('cheque2').style.display = 'none';
                        document.getElementById('cheque3').style.display = 'none';
                        document.getElementById('cheque4').style.display = 'none';
                    };
                };
            };

            function acceptPaymentCondition() {
                var checkBox = document.getElementById("payment_condition");
                var text = document.getElementById("soumettre");
                if (checkBox.checked == true) {
                    text.style.display = "block";
                } else {
                    text.style.display = "none";
                }
            }

            function updateTotals() {
                let total_f = 0;
                let total_g = 0;
                let total_g_2 = 0;
                let total_h = 0;
                let total_i = 0;
                let total_i2 = 0;
                let total_j = 0;

                /* Update G (It may be abscent from the DOM so we need to handle it specially)*/
                let member_number_el = document.getElementById('member_number');
                let member_amount_el = document.getElementById('member_amount');
                if (member_number_el &amp;&amp; member_amount_el) {
                    let up_total_g = member_number_el.value * member_amount_el.value;
                    total_g = parseFloat(up_total_g);
                    document.getElementById('hidden_total_g').value = up_total_g;
                    document.getElementById('label_total_g').textContent =
                        up_total_g.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ") + " DH";
                }

                /* Update G2 */
                let amount_member_c = document.getElementById('amount_member_c').value;
                let discount = document.getElementById('discount').value;
                let part_up_total_g_2 = amount_member_c * (1 - normalize(discount));

                /* Update F */
                let number_member_d = document.getElementById('number_member_d').value || 0;
                let number_members_50 = document.getElementById('number_members_50').value || 0;
                let number_members_exo = document.getElementById('number_members_exo').value || 0;
                let amount_member_e = document.getElementById('amount_member_e').value;
                let up_total_f = (parseInt(number_member_d) + parseFloat((number_members_50 * 0.5))) *
                    parseInt(amount_member_e);
                total_f = parseFloat(up_total_f);

                /* Update H */
                // Initialize tranche values
                let ca_tranche_1 = 0;
                let ca_tranche_2 = 0;
                // Get CA value
                let ca_amount = parseFloat(document.getElementById('ca_amount').value.replace(/\s+/g, ''));
                // Calculate plafond 1 and use it
                let ca_plafond_1_value = Math.min(ca_amount, 50000000);
                document.getElementById('ca_plafond_1').textContent =
                    ca_plafond_1_value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ") + " DH";
                // Calculate tranche 1
                ca_tranche_1 = 0.0025 * ca_plafond_1_value;
                document.getElementById('hidden_ca_tranche_1').value = ca_tranche_1.toFixed(2);
                document.getElementById('label_ca_tranche_1').textContent =
                    ca_tranche_1.toFixed(2).toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ") + " DH";
                // Get tranche 2 section containers
                let l_tranche_2_section = document.getElementById('l_ca_section_2');
                let tranche_2_section = document.getElementById('ca_section_2');
                if (ca_plafond_1_value !== ca_amount) {
                    // Show tranche 2 section containers
                    l_tranche_2_section.style.display = 'block';
                    tranche_2_section.style.display = 'block';
                    // Calculate plafond 2 and use it
                    let ca_plafond_2_value = ca_amount;
                    document.getElementById('ca_plafond_2').textContent =
                        ca_plafond_2_value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ") + " DH";
                    // Calculate tranche 2
                    ca_tranche_2 = 0.0015 * parseFloat(ca_plafond_2_value - ca_plafond_1_value);
                    document.getElementById('hidden_ca_tranche_2').value = ca_tranche_2.toFixed(2);
                    document.getElementById('label_ca_tranche_2').textContent =
                        ca_tranche_2.toFixed(2).toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ") + " DH";
                } else {
                    // Hide tranche 2 section containers
                    l_tranche_2_section.style.display = 'none';
                    tranche_2_section.style.display = 'none';
                };
                let up_total_h = (parseFloat(ca_tranche_1) + parseFloat(ca_tranche_2)).toFixed(2);
                total_h = parseFloat(up_total_h);

                /* Update I1 */
                let mandat_number = document.getElementById('number_mandat').value;
                let up_total_i = mandat_number * 200; // the value 200 must be passed from the backend for better maintainability
                total_i = parseFloat(up_total_i);

                /* Update I2 */
                let s_office_number = document.getElementById('number_s_office').value;
                let up_total_i2 = s_office_number * 1000; // the value 1000 must be passed from the backend for better maintainability
                total_i2 = parseFloat(up_total_i2);

                /* Update J */
                let no_exo = parseInt(number_member_d) + parseInt(number_members_50);
                let up_total_j = no_exo * 1500;
                total_j = parseFloat(up_total_j);

                // Update hidden inputs
                let up_total_g_2 = part_up_total_g_2 + up_total_f;
                total_g_2 = up_total_g_2;
                let up_pm_total = total_g_2 + total_h + total_i + total_i2 + total_j;
                let up_no_pm_total = total_g + total_h + total_i + total_j;
                document.getElementById('hidden_total_f').value = total_f.toFixed(2);
                document.getElementById('hidden_total_g_2').value = total_g_2.toFixed(2);
                document.getElementById('hidden_total_h').value = total_h.toFixed(2);
                document.getElementById('hidden_total_i').value = total_i.toFixed(2);
                document.getElementById('hidden_total_i2').value = total_i2.toFixed(2);
                document.getElementById('hidden_total_j').value = total_j.toFixed(2);
                let hidden_pm_total_el = document.getElementById('hidden_pm_total');
                if (hidden_pm_total_el) {
                    hidden_pm_total_el.value = up_pm_total.toFixed(2);
                };
                let hidden_no_pm_total_el = document.getElementById('hidden_no_pm_total');
                if (hidden_no_pm_total_el) {
                    hidden_no_pm_total_el.value = up_no_pm_total.toFixed(2);
                };

                // Format totals with thousands separator
                document.getElementById('label_total_f').textContent = up_total_f.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ") + " DH";
                document.getElementById('label_total_g_2').textContent = up_total_g_2.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ") + " DH";
                document.getElementById('label_total_h').textContent = up_total_h.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ") + " DH";
                document.getElementById('label_total_i').textContent = up_total_i.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ") + " DH";
                document.getElementById('label_total_i2').textContent = up_total_i2.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ") + " DH";
                document.getElementById('label_total_j').textContent = up_total_j.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ") + " DH";
                let label_pm_total_el = document.getElementById('label_pm_total');
                if (label_pm_total_el) {
                    label_pm_total_el.textContent = up_pm_total.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ") + " DH";
                };
                let label_no_pm_total_el = document.getElementById('label_no_pm_total');
                if (label_no_pm_total_el) {
                    label_no_pm_total_el.textContent = up_no_pm_total.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ") + " DH";
                };

                // Update other values
                document.getElementById('label_members_2').textContent = no_exo.toString();
                document.getElementById('label_members_exo').textContent = parseInt(number_members_exo).toString()

            };

            // Load totals on page load
            window.onload = function () {
                updateTotals();
                const fileInput = document.getElementById('justif_ca');
                if (fileInput) {
                    loadJustifFile();
                };

            };
        </script>
    </template>

    <template id="portal_cotisation_submit">
        <t t-call="portal.portal_layout">
            <t t-set="additional_title">Confirmation</t>
            <form action="/registration/submit" method="post">
                <input type="hidden" name="csrf_token"
                       t-att-value="request.csrf_token()"/>
                <div class="row o_portal_details col-xl-8">
                    <div class="alert alert-danger float-center"
                         style="position: absolute" role="alert">
                        <h4 class="alert-heading">Confirmation!</h4>
                        <p>Vous êtes sur le point de valider votre cotisation. Voulez vous
                            continuer?
                        </p>
                        <hr/>
                        <p class="mb-0">
                            <a href="/registration"
                               class="mb-2 btn btn-secondary rounded-circle btn-sm">
                                Retour
                            </a>
                            <button type="submit"
                                    class="mb-2 btn btn-secondary rounded-circle btn-sm float-right">
                                Confirmer
                            </button>

                        </p>
                    </div>
                </div>
            </form>
        </t>
    </template>

    <template id="portal_cotisation_submit_success">
        <t t-call="portal.portal_layout">
            <t t-set="additional_title">Dossier Soumis</t>
            <form action="/submit/success" method="post">
                <input type="hidden" name="csrf_token"
                       t-att-value="request.csrf_token()"/>
                <div id="wrap">
                    <div class="oe_structure">
                        <div class="container">
                            <div class="row">
                                <div class="col-lg-12">
                                    <h1 class="text-center">Félicitations!</h1>
                                    <p class="text-center">
                                        Votre cotisation a été soumis avec succès.
                                    </p>
                                </div>
                            </div>
                            <div class="row" id="o_submit">
                                <div class="col-lg-12 text-center mt32 mb32">
                                    <button type="submit"
                                            class="btn btn-primary float-center mb32 ">
                                        Continuer sur notre site Web
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </form>
            <style>
                #top {
                display:none;
                }

                #wrapwrap.o_portal {
                background-color: #80808000 !important;
                background-size: 100vw 100vh;
                background-image:
                url(http://51.77.194.119:12000/mandat_cotisation_management/static/src/img/background-3.png);
                }


                .o_portal_wrap .o_portal_navbar {
                background-color: white !important;
                display: none;
                }

                .o_portal_wrap{
                margin-top: 49px;
                }

                table {
                background-color: #ffffff00 !important;
                }
                .i-header {
                background-image:
                url(http://51.77.194.119:12000/mandat_cotisation_management/static/src/img/top-layer.png);
                width: 100vw;
                height: 190px;
                background-repeat: no-repeat;
                background-size: 100vw 153px;
                position: absolute;
                top: 0;
                left: 0;
                z-index: 1000;
                display:flex;
                }
                .i-header ul {
                display: flex;
                list-style: none;
                color: white;
                }

                .i-header li {
                margin: 25px 20px;
                }

                .i-header .buttons button {
                background: #9a3131;
                padding: 4px 30px;
                border: none;
                border-radius: 40px;
                color: white;
                backdrop-filter: blur(0px);
                margin-top: 7px;
                display: flex;
                justify-content: center;
                }
                .i-header .buttons .button{
                background: #b6a9a8ad;
                padding: 4px 30px;
                border: none;
                border-radius: 40px;
                color: white;
                backdrop-filter: blur(0px);
                margin-top: 7px;
                }

                .i-header .buttons {
                display: flex;
                flex-direction: column;
                position: absolute;
                right: 33px;
                top: 33px;
                }

                .h-divider {
                width: 2px;
                height: 28px;
                background: white;
                margin: 22px -3px;
                }

                main {
                margin-left: 0px;
                }

                .table-responsive {
                margin-top: 9rem;
                }

                ul li a {
                color: white;
                }

                ul li a:hover {
                color: white;
                text-decoration: underline;
                }

                .button a:hover {
                color: white;
                text-decoration: none;
                }


                .i-header .buttons .button {
                background: #9a3131;
                padding: 4px 30px;
                border: none;
                border-radius: 40px;
                color: white;
                backdrop-filter: blur(0px);
                margin-top: 7px;
                display: flex;
                justify-content: center;
                }

                #bottom {
                display: none;
                }
                .i-header .buttons {
                display: flex;
                flex-direction: column;
                position: absolute;
                right: 33px;
                top: 14px;
                }

                .i-header {
                background-image:
                url(http://51.77.194.119:12000/mandat_cotisation_management/static/src/img/top-layer.png);
                width: 100vw;
                height: 190px;
                background-repeat: no-repeat;
                background-position-x: center;
                background-size: 120vw 153px;
                position: absolute;
                top: 0;
                left: 0;
                z-index: 1000;
                display: flex;
                }
                @media only screen and (max-width: 900px){
                .i-header {
                background-size: 100vw 80px;
                }
                .i-header ul {
                display: none;
                }
                .i-header .buttons {
                display: flex;
                flex-direction: row;
                align-items: center;
                margin-top: -25px;
                }

                main {
                margin-left:0px !important;

                }

                #wrapwrap.o_portal {
                background-color: #80808000 !important;
                background-size: auto !important;
                background-image:
                url(http://51.77.194.119:12000/mandat_cotisation_management/static/src/img/background-3.png);
                }

                .i-header .buttons {
                gap: 17px;
                top: 29px;
                }

                }
            </style>
        </t>
    </template>

    <template id="portal_cotisations" name="Cotisations">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True"/>

            <t t-call="portal.portal_searchbar">
                <t t-set="title">Cotisations</t>
            </t>
            <t t-if="not cotisations">
                <p>There are currently no cotisation for your account.</p>
            </t>
            <t t-if="cotisations" t-call="portal.portal_table">
                <thead>
                    <tr class="active">
                        <th>#</th>
                        <th class="text-left">Année</th>
                        <th class="text-left">Nom</th>
                        <th class="text-left">Prénom</th>
                        <th class="text-left">Total</th>
                        <th class="text-left">Etat</th>
                        <th class="text-left"></th>
                    </tr>
                </thead>
                <t t-foreach="cotisations" t-as="cotisation">
                    <tr>
                        <td class="text-left">
                            #
                        </td>
                        <td class="text-left">
                            <a t-attf-href="/cotisation/new/#{slug(cotisation)}">
                                <span t-field="cotisation.year"/>
                            </a>
                        </td>
                        <td class="text-left">
                            <span t-field="cotisation.name"/>
                        </td>
                        <td class="text-left">
                            <span t-field="cotisation.prenom"/>
                        </td>
                        <td class="text-left">
                            <span t-field="cotisation.total"/>
                        </td>
                        <td class="text-left">
                            <t t-if="cotisation.state == 'draft'">
                                <span class="badge badge-pill badge-success">Brouillon</span>
                            </t>
                            <t t-if="cotisation.state == 'waiting_validation'">
                                <span class="badge badge-pill badge-success">En attente de validation par le CROEC
                                </span>
                            </t>
                            <t t-if="cotisation.state == 'validated'">
                                <span class="badge badge-pill badge-success">Validée et Attente de paiement</span>
                            </t>
                            <t t-if="cotisation.state == 'waiting_payment_validation'">
                                <span class="badge badge-pill badge-success">Paiement en attente de validation par le
                                    CROEC
                                </span>
                            </t>
                            <t t-if="cotisation.state == 'payment_validated'">
                                <span class="badge badge-pill badge-success">Paiement validé</span>
                            </t>
                            <t t-if="cotisation.state == 'comptabilise'">
                                <span class="badge badge-pill badge-success">Comptabilisé</span>
                            </t>
                        </td>
                        <td class="text-center">
                            <a t-attf-href="/cotisation/new/#{slug(cotisation)}"
                               class="btn btn-secondary rounded-circle btn-sm">
                                Déclaration réctificative
                            </a>
                        </td>
                    </tr>
                </t>
            </t>
            <br/>
            <a t-attf-href="/cotisation/new" style="font-size:10px"
               class="btn btn-primary float-center mb32">Nouvelle cotisation
            </a>
        </t>
    </template>
</odoo>
